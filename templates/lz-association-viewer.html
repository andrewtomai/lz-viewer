
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LocusZoom Plugin Demo</title>

  <script src="https://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>

  <!-- Necessary includes for LocusZoom -->
  <script src="http://portaldev.sph.umich.edu/lz-amp/locuszoom.vendor.min.js" type="text/javascript"></script>
  <!--<script src="http://portaldev.sph.umich.edu/lz-amp/locuszoom.next.js" type="text/javascript"></script>-->
	<script src="http://portaldev.sph.umich.edu/lzplug/locuszoom.app.js" type="text/javascript"></script>
  <link rel="stylesheet" type="text/css" href="http://portaldev.sph.umich.edu/lz-amp/locuszoom.next.css"/>

</head>

<body style="background-color: #CCCCCC; margin: 10px;" onload="initPage()">
	<table border="0" cellspacing="10">
		<tr>
			<td>
				<div>
					<form>
						<b>lz-1</b> &middot;
						<label for="lz-1_region">Region: </label>
						<input type="text" size=25 id="lz-1_region">
						<input type="button" id="lz-1_submit" value="Go" onClick="changeRegion('lz-1');" />
					</form>
					<br>
				</div>
				<div id="lz-1" class="lz-locuszoom-container" data-region={{ region }}></div>
			</td>
			<td style="vertical-align:top">
				<h3>Top Hits</h3>
				<div id="tophits"></div>	
			</td>
		</tr>
	</table>
  <script type="text/javascript">

    // Define LocusZoom Data Sources object
	var localBase = "http://127.0.0.1:" + {{ port }} + "/api/";
    var remoteBase = "http://portaldev.sph.umich.edu/api/v1/";
    var data_sources = new LocusZoom.DataSources();
    data_sources.addSource("base", ["AssociationLZ", localBase]);
    data_sources.addSource("ld", ["LDLZ" ,remoteBase + "pair/LD/"]);
    data_sources.addSource("gene", ["GeneLZ", { url: remoteBase + "annotation/genes/", params: {source: 2} }]);
    data_sources.add("sig", ["StaticJSON", [{ "x": 0, "y": 4.522 }, { "x": 2881033286, "y": 4.522 }] ])
    //data_sources.add("recomb", ["RecombLZ", { url: apiBase + "annotation/recomb/results/", params: {source: 15}])

    var my_layout = {
    	panels: {
    		positions: {
    			fields: ["id", "position", "pvalue|scinotation", "pvalue|neglog10", "ld:state"],
    			data_layers: {
    				positions: {
    					fields: ["id", "position", "pvalue|scinotation", "pvalue|neglog10", "ld:state"],
    					tooltip: {
    						html: "<strong>{{id}}</strong>"
    					}
    				}
    			}
    		}
    	}
    };
	
    var layout = LocusZoom.mergeLayouts(my_layout, LocusZoom.StandardLayout);


    // Populate the div with a LocusZoom plot using the default layout
    var demo_instance = LocusZoom.populate("#lz-1", data_sources, layout);


    var topHits = {{ hits|tojson }};
    // Apply form data to a remapping of the demo LocusZoom instance
    function handleFormSubmit(lz_id){
    	//var chr   = $("#" + lz_id + "_chr")[0].value;
    	//var start = $("#" + lz_id + "_start")[0].value;
    	//var end   = $("#" + lz_id + "_end")[0].value;
    	var target =  $("#" + lz_id + "_region")[0].value.split(":");
    	var chr = target[0];
    	var pos = target[1];
    	var start = 0;
    	var end = 0;
    	if ( pos.match(/[-+]/) ) {
    		if (pos.match(/[-]/)) {
    			pos = pos.split("-");
    			start = +pos[0];
    			end = +pos[1];
    		} else {
    			pos = pos.split("+");
    			start = (+pos[0]) - (+pos[1]);
    			end = (+pos[0]) + (+pos[1]);
    		}
    	} else {
    		start = +pos - 300000
    		end = +pos + 300000
    	}
    	demo_instance.applyState({ chr: chr, start: start, end: end});
    }

    function jumpTo(region) {
    	var target = region.split(":");
    	var chr = target[0];
    	var pos = target[1];
    	var start = 0;
    	var end = 0;
    	if (!pos.match(/[-+]/)) {
    		start = +pos - 300000
    		end = +pos + 300000
    	}
    	demo_instance.applyState({ chr: chr, start: start, end: end, ldrefvar: "" });
    	populateForms();
    	return(false);
    }

    function listHits() {
    	$("#tophits").empty().append("<ul>").children(0).append(topHits.map(function(e) {
    		return "<li><a href='javascript:jumpTo(\"" + e[0] + "\");'>" + e[1] + " </a></li>";
    	}))
    }



    // Apply form data to a remapping of the demo LocusZoom instance
    function changeRegion(lz_id){
    	var target =  LocusZoom.parsePositionQuery($("#" + lz_id + "_region")[0].value);
    	demo_instance.state.ldrefvar = "";
    	demo_instance.mapTo(target.chr, target.start, target.end);
    }


    	// Fill demo forms with values already loaded into LocusZoom objects
    function populateForms(){
      $("#lz-1_region")[0].value = demo_instance.state.chr + ":"
                                 + demo_instance.state.start + "-"
                                 + demo_instance.state.end;
    }

    function initPage() {
		listHits();
		populateForms();
		$("#lz-1_hits").html(topHits.map(function(k) {return "<option>" + k + "</option>"}).join(""));
    };

  </script>

</body>
</html>
